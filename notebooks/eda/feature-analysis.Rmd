---
title: "xG-model: features"
output: html_notebook
---

```{r warning=FALSE, message=FALSE}
library(here)
library(dplyr)
library(ggplot2)
library(gridExtra)
library(tidyr)
```

# Read data

## Raw data

```{r}
events_2017 <- readRDS(here("data", "raw", "events_2017.rds"))
events_2018 <- readRDS(here("data", "raw", "events_2018.rds"))
fixtures_2017 <- readRDS(here("data", "raw", "fixtures_2017.rds"))
fixtures_2018 <- readRDS(here("data", "raw", "fixtures_2018.rds"))
player_details <-readRDS(here("data", "raw", "player_details.rds"))
events <- events_2017 %>% bind_rows(events_2018)
fixtures <- fixtures_2017 %>% bind_rows(fixtures_2018)
actions <- events %>% distinct(action_id, action_name) %>% arrange(action_id)
source(here("src", "utility", "pitch_polygons.R"))
source(here("src", "utility", "theme_pitch.R"))
pitch_polygons <- pitch_polygons() %>% mutate_at(vars(x, y), funs(. / 100))
home_team <- fixtures %>% select(id, team1_id, team2_id) %>%
  rename(home_team_id = team1_id, away_team_id = team2_id, match_id = id)
pref_foot <- player_details %>% select(id, foot_name) %>%
  rename(player_id = id, pref_foot = foot_name)
end_of_first_half <- events %>% filter(action_id == 18030) %>% 
  select(match_id, second) %>% rename(end_of_first_half = second)

rm(events_2017, events_2018, fixtures_2017, fixtures_2018)
```

## Clean events data

Far from all events (or actions) are needed.

* Gets rid off redundant variables ending with _name
* Remove unneccessary rows
* Flags succeeding event with action
    + Successful dribble (2051)
    + Opening (28090)
* Move pass_type & pass_accurate to n preceeding passes instead


```{r}
drop_vars <- grep("_name$", names(events), value = TRUE)
drop_vars <- setdiff(drop_vars, c("action_name", "body_name"))
drop_vars <- c(drop_vars, "ts")

# accurate <- c(1011, 1021, 1031, 1040, 1050, 1061, 1070)
# inaccurate <- c(1012, 1022, 1032, 1062)

is_accurate_pass <- function(id) {
  id %in% c(1011, 1021, 1031, 1040, 1050, 1061, 1070)
}

is_inaccurate_pass <- function(id) {
  id %in% c(1012, 1022, 1032, 1062)
}

is_pass <- function(id) {
  is_accurate_pass(id) | is_inaccurate_pass(id)
}

is_shot <- function(id) {
  id %in% c(4010, 4020, 4030, 4040, 4050, 8010)
}

preceeded_by_dribble <- function(id, player, position) {
  # Base case: No
  v <- rep(0L, length(id))
  # Dribble
  idx <- which(id == 2051)
  # Succeeding event
  lead_idx <- idx + 1L
  # Events preceeded by dibble
  v[lead_idx] <- as.integer(player[lead_idx] == player[idx])
  # Events preceeded by dribble of GK
  idx <- which(v == 1L)
  v[idx] <- v[idx] + as.integer(position[idx - 1L] == 31)
  y <- rep("No", length(id))
  y[v == 1] <- "Player"
  y[v == 2] <- "Goalkeeper"
  
  y
}

preceeded_by_opening <- function(id, player) {
  # Base case: No
  v <- rep(0L, length(id))
  # Opening
  idx <- which(id == 28090)
  v[idx + 1] <- as.integer(player[idx + 1] == player[idx])
  
  v
}

ball_movement <- function(y1, y2) {
  # Distance within rows
  d_row <- abs(y1 - y2)
  d_row[is.na(d_row)] <- 0
  d_row <- cumsum(d_row)
  
  # Distance between rows
  d_lag <- abs(y1 - lag(y2))
  d_lag[is.na(d_lag)] <- 0
  d_lag <- cumsum(d_lag)
  
  # Within up to previous row + total distance between rows
  d_tot <- d_lag + lag(d_row)
  # First row in each group  will be NA
  d_tot[1] <- 0
  
  
  d_tot
}

pass_type <- function(id) {
  v <- rep(NA_character_, length(id))
  v[id %in% c(1021, 1022)] <- "Non attacking"
  # Assuming assists (1040) are attacking
  v[id %in% c(1011, 1012, 1040)] <- "Attacking"
  v[id %in% c(1061, 1062, 1070)] <- "Extra attacking"
  v[id %in% c(1031, 1032, 1050)] <- "Key"
  
  v
}

set_body_name <- function(x) {
  v <- rep(NA_character_, length(x))
  v[x %in% c(1, 2)] <- "Foot"
  v[x == 3] <- "Header"
  v[x == 4] <- "Body"
  v[x == 5] <- "Hand"
  
  v
}

set_attack_type <- function(x) {
  v <- rep(NA_character_, length(x))
  v[x == 1] <- "Positional attack"
  v[x == 2] <- "Counter attack"
  v[x == 3] <- "Corner attack"
  v[x == 4] <- "Free-kick attack"
  v[x == 5] <- "Penalty attack"
  v[x == 6] <- "Throw-in attack"
  
  v
}

set_standart <- function(x) {
  v <- rep(NA_character_, length(x))
  v[x == 1] <- "Open play"
  v[x == 2] <- "Throw-in"
  v[x == 3] <- "Indirect free kick"
  v[x == 4] <- "Free kick"
  v[x == 5] <- "Corner"
  v[x == 6] <- "Penalty"
  v[x == 7] <- "Interruption"
  
  v
}

events_clean <- events %>%
  select(-one_of(drop_vars)) %>%
  # Add home and away team
  inner_join(home_team, by = "match_id") %>%
  # Add player preferred foot 
  left_join(pref_foot, by = "player_id") %>%
  # Second when first half ended
  inner_join(end_of_first_half, by = "match_id") %>%
  # sort data
  arrange(match_id, half, second, id) %>%
  # remove unnecessary rows
  filter(
    !(action_id %in% c(2040, 2060)),              # Loss of ball/ball recovery
    !(action_id %in% c(3020, 3030, 3080, 3100)),  # Cards
    action_id != 10000,                           # Bad ball control
    floor(action_id / 1000) != 13,                # Goalkeeper actions
    floor(action_id / 1000) != 14,                # Substitution
    floor(action_id / 1000) != 15,                # Formations
    floor(action_id / 1000) != 16,                # Line-up positions
    floor(action_id / 1000) != 18,                # Match start, half time etc.
    floor(action_id / 1000) != 19,                # Misstakes
    floor(action_id / 1000) != 21,                # Possession
    action_id != 22000,                           # Ball receiving
    floor(action_id / 1000) != 23,                # Playing in goal scoring attack
    floor(action_id / 1000) != 25,                # Average positions
    floor(action_id / 1000) != 26,                # Crosses
    !(action_id %in% c(28010, 28011, 28012)),     # Diagonal passes (labels on main passes)
    action_id != 28020,                           # Key interception
    action_id != 28030,                           # Pass behind player. Rarely filled in
    floor(action_id / 10) != 2804,                # Set piece atttack crosses
    action_id != 28070,                           # Bicycle kick. Rarely filled in
    !(action_id %in% c(28050, 28060, 28080)),     # Players that created offside trap etc.
    action_id != 28100,                           # At high speed - Rarely related to shots and passes
    action_id != 28110,                           # Pass into offside
    floor(action_id / 1000) != 29,                # Points on the video
    action_id < 30000                             # action_id > 30000 not needed
  ) %>%
  # Add indicators
  mutate(
    dribble = preceeded_by_dribble(action_id, player_id, opponent_position_id),
    opening = preceeded_by_opening(action_id, player_id),
    pass_shot_from = set_body_name(body_id),
    attack_type = set_attack_type(attack_type_id),
    standart = set_standart(standart_id),
    match_second = ifelse(half == 1, second, end_of_first_half + second)
  ) %>%
  # Added as indicator on event instead
  filter(
    action_id != 2051,
    action_id != 28090,
    !is.na(possession_number)
  ) %>%
  group_by(match_id, half, possession_number) %>%
  mutate(
    # Home team?
    home_team = as.integer(team_id == home_team_id),
    # Nbr of passes within possession
    n_pass = cumsum(is_pass(action_id)),
    # Nbr of accurate passes
    n_accurate_pass = cumsum(is_accurate_pass(action_id)),
    # Shot nbr in possession
    shot_nbr = cumsum(is_shot(action_id)),
    # Nbr of shots in possession
    n_shots = max(shot_nbr),
    # Start coordinates of possession
    pos_start_x = first(pos_x),
    pos_start_y = first(pos_y),
    zone_start_id = first(zone_id),
    # Start second and elapsed time since start of possession
    second_start = first(second),
    ds = second - second_start,
    # Total vertical ball movement from starting x coordinate
    v_distance = ball_movement(pos_x, pos_dest_x),
    # Total horizontal ball movement from starting y coordinatte
    h_distance = ball_movement(pos_y, pos_dest_y),
    # Vertical movement of the ball from starting x coordinate
    attack_distance = pos_x - pos_start_x,
    # Speed vertical ball movement
    v_speed = ifelse(ds == 0, NA, v_distance / ds),
    # Speed horizontal ball movement
    h_speed = ifelse(ds == 0, NA, h_distance / ds),
    # Speed of attack
    attack_speed = ifelse(ds == 0, NA, attack_distance / ds)
  ) %>%
  # Add row identifier
  ungroup() %>%
  mutate(row_id = row_number())

events_clean %>% count(action_id, action_name)
```

## Shots

* Shot on target – is a shot, reflected by the goalkeeper. Even if there is doubt about the accuracy of the shot, but it was saved, it is noted as shot on target. If the goalkeeper saves after a ricochet without significant change of trajectory, shot on target is also noted.
* Shot wide – is a shot not reaching the target. The ball crosses the front line, sideline, or even remains in the field. If the shot goes considerably off target, but the keeper rushes towards it and picks it up, it is still a shot wide.
* Shot into the post – is a shot when the ball hit the goal frame (a post or a bar). If the ball hits the post after a ricochet from the goalkeeper or a field player, this is shot on target or an intercepted shot.
* Shot saved by a field player – is a shot intercepted or blocked by an opponent field player when there is no goalkeeper between the player and goal.
* Intercepted shot - is a shot intercepted or blocked by an opponent outside the goalkeeper's box
* Leaving out own goals, don't think they should be included

```{r}
shots <- events_clean %>%
  filter(is_shot(action_id)) %>%
  rename(shot_from = pass_shot_from) %>%
  mutate(goal = as.integer(action_id == 8010))

shots %>%
  count(action_id, action_name)
```

There is one expected goal in every ten shots. Don't know what the distinction is between 4040 and 4050. It is not clear by the documentation above, and they both have the goalkeeper as the opponent_position_name. 

```{r}
shots %>%
  filter(action_id %in% c(4010, 4040, 4050)) %>%
  count(action_name, opponent_position_id)
```

Judging by the coordinates some shots looks more likely to be crosses or passes. Still kepping all because it's hard to decide the original intent. 

```{r}
ggplot(shots, aes(pos_x, pos_y)) +
  geom_polygon(data = pitch_polygons, aes(x, y, group = id), alpha = 0, colour = "white") +
  geom_point() +
  theme_pitch()
```

# Features

Done

* Preceeding n passes
    + length
    + direction
    + zone_id
    + pos_x, pos_y
    + type, assists can be written as extra attacking, key or other (attacking or non attacking)
    + Opening
    + Succeeding an opening
    + Succeeding a dribble (player or goalkeeper)
    + Standart
* Possession time before shot
* Number of passes before shot
* Number of accurate passes before shot
* Speed
    + Attack
    + Vertical
    + Horizontal
* Distance
    + Attack
    + Vertical
    + Horizontal
* Start of attack position
    + Coordinates
    + Zone
* Shot succeeding a dribble
    + of player
    + of goalkeeper
* Succeeding an opening
* Body name
* Correct foot
* Second
* Shot angle & distance
* Type of attack, i.e. free kick, corner, open play, counter attack.
* Standart (i.e. type of kick)
* Shot after reflection in wood/keeper/player
* Shot after challenge
* Shot nbr in possession
* Number of shots per possession (to adjust xG)
* Game state
* Home team

Possible features:

* At high speed
    + Rarely related to shots or passes. Removed.
* Height/Weight. Height should be important for headers.
    + Should player specific metrics be included?

## Shot angle & distance

```{r}
s <- 7.32
y1 <- (68 + s) / 2
y2 <- (68 - s) / 2
# law_of_cosines c^2 = a^2 + b^2 - 2*a*b*cos(C)
shots <- shots %>%
  mutate(
    a = sqrt( (105 - pos_x) ^ 2 + (y1 - pos_y) ^ 2),
    b = sqrt( (105 - pos_x) ^ 2 + (y2 - pos_y) ^ 2),
    shot_dist = ifelse(pos_y > y2 & pos_y < y1, 105 - pos_x, pmin(a, b)),
    shot_angle = acos(x = (a ^ 2 + b ^ 2 - s ^ 2) / (2 * a * b))
  ) %>%
  select(-a, -b)

rm(s, y1, y2)
```

## Correct foot

```{r}
correct_foot <- function(score_foot, pref_foot) {
  # Adjust strings so they match
  foots <- c("Right", "Left")
  idx <- which(pref_foot %in% foots)
  pref_foot[idx] <- paste(pref_foot[idx], "foot")
  foots <- paste(foots, "foot")
  # Base case
  v <- rep("No", length(score_foot))
  # Correct foot?
  v[score_foot == pref_foot] <- "Yes"
  v[(score_foot %in% foots) & pref_foot == "Both"] <- "Yes"
  v[(score_foot %in% foots) & is.na(pref_foot)] <- "Unknown"
  # Other body part?
  v[!(score_foot %in% foots)] <- "Other"
  
  v
}

shots <- shots %>% mutate(correct_foot = correct_foot(body_name, pref_foot))

rm(correct_foot)
```

## Preceeding N passes

```{r}
# Challenges don't necessarily interupt the passing sequence
drop_ids <- c(2010, 2020)

passes_before_shot <- events_clean %>%
  filter(!(action_id %in% drop_ids)) %>%
  mutate(
    ok = is_shot(action_id) | is_pass(action_id),
    # ok = action_id %in% c(accurate, inaccurate, shot_ids),
    ok = ok & (player_id == lag(opponent_id)),
    ok = ok & (team_id == lag(team_id)),
    ok = ok & (possession_number == lag(possession_number)),
    ok = ifelse(is.na(ok), FALSE, ok),
    pass_seq = cumsum(!ok)
  ) %>%
  group_by(pass_seq) %>%
  filter(sum(is_shot(action_id)) > 0) %>%
  arrange(desc(second)) %>%
  filter(row_number() <= 3) %>%
  mutate(row_id = first(row_id)) %>%
  filter(!is_shot(action_id)) %>%
  mutate(pass_nbr = row_number()) %>%
  ungroup() %>%
  mutate(
    # Length (already in dataset but seems weird)
    len = sqrt( (pos_dest_x - pos_x) ^ 2 + (pos_dest_y - pos_y) ^ 2),
    # Direction (already in dataset but is definitely weird)
    # 1 is forward, -1 ir backward and 0 is sideways pass (right or left)
    dir = ifelse(len == 0, NA, (pos_dest_x - pos_x) / len),
    # Pass type (including assist marked as attacking, key etc.)
    pass_type = pass_type(action_id)
  ) %>%
  select(row_id, pass_nbr, standart, len, dir, pos_x, pos_y, zone_id,
    pass_type, dribble, opening, pass_shot_from) %>%
  rename(from = pass_shot_from) %>%
  gather(variable, value, -row_id, -pass_nbr) %>%
  mutate(new_var = paste("pass", pass_nbr, variable, sep = "_")) %>%
  select(-pass_nbr, -variable) %>%
  spread(new_var, value)

shots <- shots %>%
  left_join(passes_before_shot, by = "row_id")

rm(drop_ids, passes_before_shot)
```

## Shot after shot

Shot after

* Shot blocked
* Shot into bar/post
* Shot on target

```{r}
shot_rebound <- function(id) {
  v <- rep(NA, length(id))
  v[id == 4010] <- "On target"
  v[id == 4030] <- "Wood"
  v[id %in% c(4040, 4050)] <- "Blocked"
  
  v
}

df <- events_clean %>%
  # Remove challenges, shots blocked and free ball pickup as they can be
  # registered between shots
  filter(!(action_id %in% c(2010, 2020, 6010, 7000))) %>%
  mutate(lag_id = lag(action_id)) %>%
  filter(is_shot(action_id) & team_id == lag(team_id)) %>%
  select(row_id, lag_id) %>%
  mutate(shot_after_rebound = shot_rebound(lag_id)) %>%
  select(-lag_id)

shots <- shots %>% left_join(df, by = "row_id")

rm(shot_rebound, df)
```

## Shot after challenge

Shot after

* Challenge
* Air challenge

```{r}
df <- events_clean %>%
  mutate(
    lag_id = lag(action_id),
    shot_after_challenge = lag(action_name),
    ok = is_shot(action_id),
    ok = ok & lag_id %in% c(2010, 2020),
    ok = ok & team_id == lag(team_id),
    ok = ok & player_id == lag(player_id)
  ) %>%
  filter(ok) %>%
  select(row_id, shot_after_challenge)

shots <- shots %>% left_join(df, by = "row_id")
```

## Game state

```{r}
change_team <- function(action, team, team1, team2) {
  v <- team
  idx <- which(action == 8020)
  v[idx] <- ifelse(team[idx] == team1[idx], team2[idx], team1[idx])
  
  v
}

df <- events_clean %>%
  filter(is_shot(action_id) | action_id == 8020) %>%
  select(row_id, match_id, team_id, home_team_id, away_team_id, action_id) %>%
  mutate(
    # If own goal, change team id so the goal is registered on the correct team
    team_id = change_team(action_id, team_id, home_team_id, away_team_id),
    # home goals
    hg = ifelse(action_id %in% c(8010, 8020) & team_id == home_team_id, 1L, 0L),
    # away goals
    ag = ifelse(action_id %in% c(8010, 8020) & team_id == away_team_id, 1L, 0L)   
  ) %>%
  group_by(match_id) %>% 
  mutate(
    hg = cumsum(hg),
    ag = cumsum(ag),
    gd = ifelse(team_id == home_team_id, hg - ag, ag - hg),
    # Game state seen from the scoring teams perspective
    game_state = ifelse(action_id %in% c(8010, 8020), gd - 1, gd)
  ) %>%
  ungroup() %>%
  select(row_id, game_state)

shots <- shots %>% inner_join(df, by = "row_id")

rm(df, change_team)
```




